name: Deploy to ECS

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - '.github/workflows/deploy-v2.yml'

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
  ECS_TASK_DEFINITION: ${{ vars.ECS_TASK_DEFINITION }}
  CODEDEPLOY_APP: ${{ vars.CODEDEPLOY_APP }}
  CODEDEPLOY_GROUP: ${{ vars.CODEDEPLOY_GROUP }}
  CONTAINER_NAME: ${{ vars.CONTAINER_NAME }}
  APP_PORT: ${{ vars.APP_PORT }}
  ALB_NAME: ${{ vars.ALB_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd app
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          cd app
          pytest tests/ -v --cov=src --cov-report=term-missing

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/ecs-v2-url-shortener-github-oidc-role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-deployment-${{ github.sha }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        id: build-image
        run: |
          IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
          docker build -t $IMAGE ./app
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.build-image.outputs.image }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0' 
          severity: 'CRITICAL,HIGH'
          
      - name: Upload Trivy results to GitHub Security
        id: upload-sarif
        uses: github/codeql-action/upload-sarif@v3
        if: always() # Ensures report is uploaded even if the Trivy step failed
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Push image to ECR
        if: success()
        run: |
          docker push ${{ steps.build-image.outputs.image }}

      - name: Download task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition $ECS_TASK_DEFINITION \
            --query taskDefinition > task-definition.json

      - name: Fill in the new image ID in the task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.build-image.outputs.image }}

      - name: Register new task definition
        id: register-task-def
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://${{ steps.task-def.outputs.task-definition }} \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "task-def-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT

      - name: Create AppSpec for CodeDeploy
        run: |
          cat > appspec.json <<'EOF'
          {
            "version": 1,
            "Resources": [
              {
                "TargetService": {
                  "Type": "AWS::ECS::Service",
                  "Properties": {
                    "TaskDefinition": "TASK_DEFINITION_PLACEHOLDER",
                    "LoadBalancerInfo": {
                      "ContainerName": "CONTAINER_NAME_PLACEHOLDER",
                      "ContainerPort": CONTAINER_PORT_PLACEHOLDER
                    }
                  }
                }
              }
            ]
          }
          EOF

          sed -i "s|TASK_DEFINITION_PLACEHOLDER|${{ steps.register-task-def.outputs.task-def-arn }}|g" appspec.json
          sed -i "s|CONTAINER_NAME_PLACEHOLDER|${{ env.CONTAINER_NAME }}|g" appspec.json
          sed -i "s|CONTAINER_PORT_PLACEHOLDER|${{ env.APP_PORT }}|g" appspec.json

      - name: Deploy to ECS via CodeDeploy
        id: deploy
        run: |
          APPSPEC_CONTENT=$(cat appspec.json)

          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name $CODEDEPLOY_APP \
            --deployment-group-name $CODEDEPLOY_GROUP \
            --revision revisionType=AppSpecContent,appSpecContent="{content='$APPSPEC_CONTENT'}" \
            --query 'deploymentId' \
            --output text)
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "Deployment started: $DEPLOYMENT_ID"

      - name: Wait for deployment to complete
        run: |
          echo "Monitoring deployment: ${{ steps.deploy.outputs.deployment-id }}"
          aws deploy wait deployment-successful \
            --deployment-id ${{ steps.deploy.outputs.deployment-id }}
          echo "CodeDeploy reports deployment successful"

      # Resilient Polling Loop for Health Check
      - name: Verify deployment health (Polling)
        run: |
          echo "Fetching ALB DNS..."
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names $ALB_NAME \
            --query 'LoadBalancers[0].DNSName' \
            --output text)
          
          echo "ALB DNS: $ALB_DNS"
          URL="http://$ALB_DNS/health"
          MAX_RETRIES=10
          SLEEP_SECONDS=10
          ATTEMPT=0
          HEALTH_CODE=0

          echo "Starting health check polling on $URL..."

          while [ $ATTEMPT -lt $MAX_RETRIES ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT of $MAX_RETRIES..."

            # FIXED: Simplified curl command (removed redundant -X GET and -H "Host")
            HEALTH_CODE=$(curl -s -o /dev/null -w "%{http_code}" $URL)

            if [ "$HEALTH_CODE" == "200" ]; then
              echo "Health check passed (HTTP 200) after $ATTEMPT attempts."
              break
            fi

            echo "Health check failed with HTTP $HEALTH_CODE. Sleeping for $SLEEP_SECONDS seconds..."
            sleep $SLEEP_SECONDS

            if [ $ATTEMPT -eq $MAX_RETRIES ]; then
              echo "---"
              echo "ERROR: Health check failed after $MAX_RETRIES attempts."
              echo "---"
              exit 1
            fi
          done

          echo "Deployment verified successfully"

      - name: Deployment summary
        if: success()
        run: |
          echo "=========================================="
          echo "Deployment completed successfully!"
          echo "=========================================="
          echo "Image: ${{ steps.build-image.outputs.image }}"
          echo "Task Definition: ${{ steps.register-task-def.outputs.task-def-arn }}"
          echo "Deployment ID: ${{ steps.deploy.outputs.deployment-id }}"
          echo "Commit: ${{ github.sha }}"
          echo "=========================================="
